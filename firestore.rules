rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      // ⚠️ TEST MODE: Allow all requests (set to 'request.auth != null' for production)
      return true;
    }
    
    function getUserId() {
      return request.auth.uid;
    }
    
    // ===== ROOT LEVEL COLLECTIONS (KresAI V2) =====
    // Demo mode - Herkese tam erişim
    
    // Announcements - Duyurular
    match /announcements/{announcementId} {
      allow read, write: if true;
    }
    
    // Feed - Akış paylaşımları
    match /feed/{feedId} {
      allow read, write: if true;
    }
    
    // Notifications - Bildirimler
    match /notifications/{notificationId} {
      allow read, write: if true;
    }
    
    // Registrations - Kayıtlar
    match /registrations/{type}/{userId} {
      allow read, write: if true;
    }
    
    // Live - Canlı yayınlar
    match /live/{liveId} {
      allow read, write: if true;
    }
    
    // Daily Logs - Günlük loglar
    match /dailyLogs/{logId} {
      allow read, write: if true;
    }
    
    // Children - Çocuklar
    match /children/{childId} {
      allow read, write: if true;
    }
    
    // Invite Codes - Davet kodları
    match /inviteCodes/{codeId} {
      allow read, write: if true;
    }
    
    // Schools - Okullar (V2)
    match /schools/{schoolId} {
      allow read, write: if true;
    }
    
    // Classes - Sınıflar (V2)
    match /classes/{classId} {
      allow read, write: if true;
    }
    
    // Registrations - Kayıtlar (V2)
    match /registrations/{type}/{userId} {
      allow read, write: if true;
    }
    
    // ===== SCHOOL-BASED COLLECTIONS (Legacy) =====
    
    // School-based data access
    match /schools/{schoolId} {
      
      // Program Templates
      match /templates/{templateId} {
        // Anyone authenticated can read templates
        allow read: if isAuthenticated();
        
        // Only the creator can create/update/delete
        allow create: if isAuthenticated() && 
          request.resource.data.createdByTeacherId == getUserId();
        
        allow update: if isAuthenticated() && 
          resource.data.createdByTeacherId == getUserId();
        
        allow delete: if isAuthenticated() && 
          resource.data.createdByTeacherId == getUserId();
        
        // Program Blocks (subcollection)
        match /blocks/{blockId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
      }
      
      // Daily Plans
      match /dailyPlans/{planId} {
        // Anyone authenticated can read
        allow read: if isAuthenticated();
        
        // Anyone authenticated can create
        allow create: if isAuthenticated();
        
        // Anyone authenticated can update
        // (Teachers and admins can approve)
        allow update: if isAuthenticated();
        
        // Only creator or admin can delete
        allow delete: if isAuthenticated();
      }
      
      // Registrations
      match /registrations/{registrationId} {
        // Users can read their own registration
        allow read: if isAuthenticated() && 
          (getUserId() == registrationId || 
           getUserId() == resource.data.userId);
        
        // Only admins can write (simplified for V1)
        allow write: if isAuthenticated();
      }
      
      // Feed Items
      match /feed/{feedId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Messages
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Announcements
      match /announcements/{announcementId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Daily Logs
      match /dailyLogs/{logId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Live Sessions
      match /liveSessions/{sessionId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Homeworks
      match /homeworks/{homeworkId} {
        // Teachers can read all homeworks
        // Parents can read published homeworks
        allow read: if isAuthenticated();
        
        // Only teachers can create homeworks
        allow create: if isAuthenticated() && 
          request.resource.data.createdByTeacherId == getUserId();
        
        // Only the creator teacher can update
        allow update: if isAuthenticated() && 
          resource.data.createdByTeacherId == getUserId();
        
        // Only the creator teacher can delete
        allow delete: if isAuthenticated() && 
          resource.data.createdByTeacherId == getUserId();
      }
      
      // Homework Submissions
      match /submissions/{submissionId} {
        // Teachers can read all submissions
        // Parents can read their child's submissions
        allow read: if isAuthenticated();
        
        // Parents can create submissions for their child
        allow create: if isAuthenticated() && 
          request.resource.data.studentId != null;
        
        // Parents can update their own submissions (before sending to teacher)
        // Teachers can update submissions (for grading)
        allow update: if isAuthenticated();
        
        // Only creator or teacher can delete
        allow delete: if isAuthenticated();
      }
      
      // Exams (SınavAI)
      match /exams/{examId} {
        // Teachers can read all exams
        // Students/Parents can read published exams
        allow read: if isAuthenticated();
        
        // Only teachers can create exams
        allow create: if isAuthenticated();
        
        // Only the creator teacher can update
        allow update: if isAuthenticated();
        
        // Only the creator teacher can delete
        allow delete: if isAuthenticated();
      }
      
      // Exam Submissions
      match /examSubmissions/{submissionId} {
        // Teachers can read all submissions
        // Students/Parents can read their own submissions
        allow read: if isAuthenticated();
        
        // Students/Parents can create submissions
        allow create: if isAuthenticated();
        
        // Students can update their own submissions (before submitting)
        // Teachers can update submissions (for grading)
        allow update: if isAuthenticated();
        
        // Only creator or teacher can delete
        allow delete: if isAuthenticated();
      }
    }
  }
}
